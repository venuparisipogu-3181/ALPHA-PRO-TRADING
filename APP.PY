import streamlit as st
from streamlit_lightweight_charts import renderLightweightCharts
import pandas as pd
import yfinance as yf
import pandas_ta as ta
import time
import requests
from datetime import datetime

# --- 1. ‡∞ü‡±Ü‡∞≤‡∞ø‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡±ç ‡∞Ö‡∞≤‡∞∞‡±ç‡∞ü‡±ç ‡∞´‡∞Ç‡∞ï‡±ç‡∞∑‡∞®‡±ç ---
def send_telegram_alert(message):
    # ‡∞Æ‡±Ä ‡∞í‡∞∞‡∞ø‡∞ú‡∞ø‡∞®‡∞≤‡±ç ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞™‡±á‡∞∏‡±ç‡∞ü‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø
    token = "8289933882:AAGgTyAhFHYzlKbZ_0rvH8GztqXeTB6P-yQ"  
    chat_id = "2115666034"  
    url = f"https://api.telegram.org/bot{token}/sendMessage"
    payload = {
        'chat_id': chat_id, 
        'text': message, 
        'parse_mode': 'HTML'
    }
    try:
        requests.post(url, data=payload, timeout=10)
        st.toast("‚úÖ Telegram Alert Sent!")
    except Exception as e:
        st.error(f"Alert Failed: {str(e)}")

# --- 2. ‡∞™‡±á‡∞ú‡±Ä ‡∞∏‡±Ü‡∞ü‡∞™‡±ç ---
st.set_page_config(layout="wide", page_title="Alpha Pro Live Terminal")

# ‡∞∏‡±ç‡∞•‡∞ø‡∞∞‡∞Æ‡±à‡∞® ‡∞™‡±ç‡∞≤‡±á‡∞∏‡±ç‚Äå‡∞π‡±ã‡∞≤‡±ç‡∞°‡∞∞‡±ç‡∞≤‡±Å (‡∞∏‡±ç‡∞ï‡±ç‡∞∞‡±Ä‡∞®‡±ç‚Äå‡∞∑‡∞æ‡∞ü‡±ç‚Äå‡∞≤‡∞≤‡±ã‡∞®‡∞ø ‡∞°‡±Ç‡∞™‡±ç‡∞≤‡∞ø‡∞ï‡±á‡∞ü‡±ç ‡∞é‡∞∞‡±ç‡∞∞‡∞∞‡±ç‡∞∏‡±ç ‡∞∞‡∞æ‡∞ï‡±Å‡∞Ç‡∞°‡∞æ)
chart_placeholder = st.empty()
table_placeholder = st.empty()

# --- 3. ‡∞∏‡±à‡∞°‡±ç‚Äå‡∞¨‡∞æ‡∞∞‡±ç ‡∞ï‡∞Ç‡∞ü‡±ç‡∞∞‡±ã‡∞≤‡±ç‡∞∏‡±ç ---
st.sidebar.title("‚öôÔ∏è Strategy Control")
index_choice = st.sidebar.selectbox("üìà Index", ["NIFTY 50", "BANK NIFTY"], key="idx_unique")
tf_choice = st.sidebar.selectbox("‚è±Ô∏è Timeframe", ["1m", "5m", "15m"], key="tf_unique")
auto_refresh = st.sidebar.checkbox("üîÑ Auto Refresh (15s)", value=True)

symbol_map = {"NIFTY 50": "^NSEI", "BANK NIFTY": "^NSEBANK"}

# --- 4. ‡∞Æ‡±Ü‡∞Ø‡∞ø‡∞®‡±ç ‡∞≤‡±Ç‡∞™‡±ç ---
while True:
    try:
        # ‡∞°‡±á‡∞ü‡∞æ ‡∞°‡±å‡∞®‡±ç‚Äå‡∞≤‡±ã‡∞°‡±ç (RangeIndex Error ‡∞´‡∞ø‡∞ï‡±ç‡∞∏‡±ç)
        df = yf.download(symbol_map[index_choice], period="2d", interval=tf_choice, progress=False)
        if df.empty:
            continue
        
        df.reset_index(inplace=True)
        if isinstance(df.columns, pd.MultiIndex):
            df.columns = df.columns.get_level_values(0)
        
        # ‡∞ü‡±à‡∞Æ‡±ç ‡∞´‡∞æ‡∞∞‡±ç‡∞Æ‡∞æ‡∞ü‡±ç ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞á‡∞Ç‡∞°‡∞ø‡∞ï‡±á‡∞ü‡∞∞‡±ç‡∞≤‡±Å
        df['time'] = pd.to_datetime(df.iloc[:, 0]).view('int64') // 10**9
        df['EMA20'] = ta.ema(df['Close'], length=20)
        df['RSI'] = ta.rsi(df['Close'], length=14)
        
        last = df.iloc[-1]
        price = float(last['Close'])
        ema = float(last['EMA20'])
        rsi = float(last['RSI'])
        
        # ‡∞∏‡∞ø‡∞ó‡±ç‡∞®‡∞≤‡±ç ‡∞≤‡∞æ‡∞ú‡∞ø‡∞ï‡±ç
        signal = "üöÄ CE BUY" if (price > ema and rsi > 55) else "üìâ PE BUY" if (price < ema and rsi < 45) else "üòê WAIT"
        current_ts = int(time.time())

        # === ‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞ó‡±ç‡∞∞‡±Ä‡∞ï‡±ç‡∞∏‡±ç ‡∞™‡±ç‡∞Ø‡∞æ‡∞®‡±Ü‡∞≤‡±ç ===
        with chart_placeholder.container():
            g1, g2, g3, g4 = st.columns(4)
            g1.metric("üí∞ LTP", f"‚Çπ{price:.2f}", f"{price-ema:+.2f}")
            g2.metric("üìà EMA 20", f"‚Çπ{ema:.2f}")
            g3.metric("üìä RSI", f"{rsi:.1f}")
            g4.metric("üíπ Signal", signal)
            
            st.markdown("---")
            
            # Candlestick Chart
            candles = df[['time', 'Open', 'High', 'Low', 'Close']].tail(60).rename(
                columns={'Open':'open','High':'high','Low':'low','Close':'close'}
            ).to_dict('records')
            
            # ‡∞°‡±Ç‡∞™‡±ç‡∞≤‡∞ø‡∞ï‡±á‡∞ü‡±ç ‡∞ï‡±Ä ‡∞∞‡∞æ‡∞ï‡±Å‡∞Ç‡∞°‡∞æ ‡∞ü‡±à‡∞Æ‡±ç ‡∞∏‡±ç‡∞ü‡∞æ‡∞Ç‡∞™‡±ç ‡∞µ‡∞æ‡∞°‡∞ü‡∞Ç
            renderLightweightCharts([{
                "chart": {"layout": {"backgroundColor": "#0b0e11", "textColor": "#d1d4dc"}, "height": 350},
                "series": [{"type": 'Candlestick', "data": candles}]
            }], key=f"chart_{current_ts}")

        # === ‡∞Ü‡∞™‡±ç‡∞∑‡∞®‡±ç ‡∞∏‡±ç‡∞ü‡±ç‡∞∞‡±à‡∞ï‡±ç ‡∞ü‡±á‡∞¨‡±Å‡∞≤‡±ç ===
        with table_placeholder.container():
            st.subheader("üéØ Perfect Strikes")
            step = 50 if "NIFTY" in index_choice else 100
            atm = int(round(price / step) * step)
            
            # Strikes selection
            if "CE" in signal:
                strikes = [atm - step, atm, atm + step]
                stype = "CE"
            else:
                strikes = [atm + step, atm, atm - step]
                stype = "PE"
            
            labels = ["ITM", "ATM", "OTM"]
            
            # ‡∞ü‡±á‡∞¨‡±Å‡∞≤‡±ç ‡∞π‡±Ü‡∞°‡∞∞‡±ç‡∞∏‡±ç
            h1, h2, h3, h4 = st.columns([1, 2, 2, 2])
            h1.write("**Type**")
            h2.write("**Strike**")
            h3.write("**LTP**")
            h4.write("**Action**")
            
            for i, s in enumerate(strikes):
                r1, r2, r3, r4 = st.columns([1, 2, 2, 2])
                r1.write(labels[i])
                r2.write(f"**{s} {stype}**")
                r3.write(f"‚Çπ{price:.2f}")
                
                # ‡∞™‡±ç‡∞∞‡∞§‡∞ø ‡∞¨‡∞ü‡∞®‡±ç‚Äå‡∞ï‡±Å ‡∞Ø‡±Ç‡∞®‡∞ø‡∞ï‡±ç ‡∞ï‡±Ä
                if r4.button(f"üöÄ BUY {s}", key=f"btn_{s}_{current_ts}"):
                    msg = f"üéØ <b>ALPHA PRO ORDER</b>\nStrike: {s} {stype}\nType: {labels[i]}\nPrice: {price:.2f}"
                    send_telegram_alert(msg)
                    st.balloons()

    except Exception as e:
        st.error(f"‚ùå Error: {e}")

    if auto_refresh:
        time.sleep(15)
        st.rerun()
    else:
        st.stop()

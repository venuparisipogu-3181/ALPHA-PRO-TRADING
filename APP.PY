import streamlit as st
import yfinance as yf
import pandas as pd
import pandas_ta as ta
import requests
import time
from datetime import datetime

# --- 1. ‡∞™‡±á‡∞ú‡±Ä ‡∞∏‡±Ü‡∞ü‡∞™‡±ç ---
st.set_page_config(layout="wide", page_title="Alpha Pro Trading")

# --- 2. ‡∞ü‡±Ü‡∞≤‡∞ø‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡±ç ‡∞Ö‡∞≤‡∞∞‡±ç‡∞ü‡±ç ‡∞´‡∞Ç‡∞ï‡±ç‡∞∑‡∞®‡±ç (‡∞Æ‡±Ä ‡∞ü‡±ã‡∞ï‡±Ü‡∞®‡±ç‡∞∏‡±ç ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞á‡∞µ‡±ç‡∞µ‡∞Ç‡∞°‡∞ø) ---
def send_telegram_alert(message):
    token = "8289933882:AAGgTyAhFHYzlKbZ_0rvH8GztqXeTB6P-yQ"  # BotFather ‡∞®‡±Å‡∞Ç‡∞°‡∞ø
    chat_id = "2115666034"  # ‡∞Æ‡±Ä ‡∞ó‡±ç‡∞∞‡±Ç‡∞™‡±ç ID
    url = f"https://api.telegram.org/bot{token}/sendMessage"
    payload = {'chat_id': chat_id, 'text': message, 'parse_mode': 'HTML'}
    try:
        requests.post(url, data=payload, timeout=10)
    except Exception:
        pass

# UI ‡∞™‡±ç‡∞≤‡±á‡∞∏‡±ç‚Äå‡∞π‡±ã‡∞≤‡±ç‡∞°‡∞∞‡±ç‡∞≤‡±Å (Sync Errors ‡∞∞‡∞æ‡∞ï‡±Å‡∞Ç‡∞°‡∞æ ‡∞â‡∞Ç‡∞°‡∞ü‡∞æ‡∞®‡∞ø‡∞ï‡∞ø)
status_spot = st.empty()
chart_spot = st.empty()
table_spot = st.empty()

st.title("üöÄ Alpha Pro - Live Trading Terminal")

# --- 3. ‡∞Æ‡±Ü‡∞Ø‡∞ø‡∞®‡±ç ‡∞≤‡±Ç‡∞™‡±ç ---
while True:
    try:
        # ‡∞°‡±á‡∞ü‡∞æ ‡∞°‡±å‡∞®‡±ç‚Äå‡∞≤‡±ã‡∞°‡±ç
        df = yf.download("^NSEI", period="2d", interval="1m", progress=False)
        
        if not df.empty:
            # Sync Error (RangeIndex) ‡∞™‡∞∞‡∞ø‡∞∑‡±ç‡∞ï‡∞æ‡∞∞‡∞Ç
            df.reset_index(inplace=True)
            if isinstance(df.columns, pd.MultiIndex):
                df.columns = df.columns.get_level_values(0)

            # ‡∞á‡∞Ç‡∞°‡∞ø‡∞ï‡±á‡∞ü‡∞∞‡±ç‡∞≤‡±Å
            df['EMA20'] = ta.ema(df['Close'], length=20)
            df['RSI'] = ta.rsi(df['Close'], length=14)
            
            last_row = df.iloc[-1]
            price = float(last_row['Close'])
            rsi_val = float(last_row['RSI'])
            ema_val = float(last_row['EMA20'])

            # 1. ‡∞ü‡∞æ‡∞™‡±ç ‡∞Æ‡±Ü‡∞ü‡±ç‡∞∞‡∞ø‡∞ï‡±ç‡∞∏‡±ç (Status Panel)
            with status_spot.container():
                c1, c2, c3, c4 = st.columns(4)
                c1.metric("NIFTY 50", f"‚Çπ{price:.2f}")
                c2.metric("RSI (14)", f"{rsi_val:.1f}")
                c3.metric("EMA 20", f"‚Çπ{ema_val:.2f}")
                c4.write(f"‚è∞ Last Update: {datetime.now().strftime('%H:%M:%S')}")

            # 2. ‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç ‡∞°‡∞ø‡∞∏‡±ç‡∞™‡±ç‡∞≤‡±á (Unique Key ‡∞§‡±ã)
            with chart_spot:
                st.line_chart(df[['Close', 'EMA20']].tail(50))

            # 3. ‡∞Ü‡∞™‡±ç‡∞∑‡∞®‡±ç ‡∞ü‡±á‡∞¨‡±Å‡∞≤‡±ç & ‡∞∏‡∞ø‡∞ó‡±ç‡∞®‡∞≤‡±ç ‡∞≤‡∞æ‡∞ú‡∞ø‡∞ï‡±ç
            with table_spot.container():
                st.subheader("üéØ Live Signal & Option Chain")
                
                # ‡∞∏‡∞ø‡∞ó‡±ç‡∞®‡∞≤‡±ç ‡∞ï‡∞Ç‡∞°‡∞ø‡∞∑‡∞®‡±ç
                signal = "üöÄ CE BUY" if price > ema_val and rsi_val > 55 else "üìâ PE BUY" if price < ema_val and rsi_val < 45 else "üòê WAIT"
                st.info(f"Current Market Status: **{signal}**")

                atm = int(round(price / 50) * 50)
                strikes = [atm - 50, atm, atm + 50]
                labels = ["ITM", "ATM", "OTM"]

                # ‡∞ü‡±á‡∞¨‡±Å‡∞≤‡±ç ‡∞ï‡∞æ‡∞≤‡∞Æ‡±ç‡∞∏‡±ç
                cols = st.columns([1, 2, 2, 2])
                cols[0].write("**Type**")
                cols[1].write("**Strike**")
                cols[2].write("**Index LTP**")
                cols[3].write("**Action**")

                for i, s in enumerate(strikes):
                    r = st.columns([1, 2, 2, 2])
                    r[0].write(labels[i])
                    r[1].write(f"**{s} CE**")
                    r[2].write(f"‚Çπ{price:.2f}")
                    
                    # Duplicate Key Error ‡∞™‡∞∞‡∞ø‡∞∑‡±ç‡∞ï‡∞æ‡∞∞‡∞Ç: ‡∞°‡±à‡∞®‡∞Æ‡∞ø‡∞ï‡±ç ‡∞ï‡±Ä ‡∞µ‡∞æ‡∞°‡∞ü‡∞Ç
                    if r[3].button(f"EXECUTE {s}", key=f"btn_{s}_{int(time.time())}"):
                        msg = f"üöÄ <b>Alpha Pro Order</b>\nStrike: {s} CE\nPrice: ‚Çπ{price:.2f}\nTime: {datetime.now().strftime('%H:%M:%S')}"
                        send_telegram_alert(msg)
                        st.success(f"Sent alert for {s} CE!")
                        st.balloons()

    except Exception as e:
        st.error(f"Waiting for Data... {e}")
    
    # ‡∞Ü‡∞ü‡±ã ‡∞∞‡∞ø‡∞´‡±ç‡∞∞‡±Ü‡∞∑‡±ç
    time.sleep(15)
    st.rerun()

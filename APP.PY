import streamlit as st
import pandas as pd
import time
import math
import requests
from datetime import datetime

# Page config
st.set_page_config(layout="wide", page_title="ğŸš€ Alpha Pro v4.0")

# Custom CSS
st.markdown("""
<style>
    .main-header {font-size: 3rem; color: #1f77b4; text-align: center;}
    .metric-card {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;}
</style>
""", unsafe_allow_html=True)

# Title
st.markdown('<h1 class="main-header">ğŸš€ ALPHA PRO TERMINAL v4.0</h1>', unsafe_allow_html=True)
st.markdown("**LIVE Options Dashboard | Greeks | OI | PCR | Auto Signals**")

# Session state
if 'cash' not in st.session_state:
    st.session_state.cash = 500000
if 'positions' not in st.session_state:
    st.session_state.positions = []

# Sidebar
st.sidebar.title("âš™ï¸ Control Panel")
index_choice = st.sidebar.selectbox("ğŸ“ˆ Index", ["NIFTY", "BANKNIFTY"])
auto_refresh = st.sidebar.checkbox("ğŸ”„ Auto Refresh (8s)", value=True)

# Telegram function
def send_telegram(msg):
    try:
        token = "8289933882:AAGgTyAhFHYzlKbZ_0rvH8GztqXeTB6P-yQ"
        chat_id = "2115666034"
        url = f"https://api.telegram.org/bot{token}/sendMessage"
        requests.post(url, data={
            'chat_id': chat_id,
            'text': msg[:4000],
            'parse_mode': 'HTML'
        }, timeout=5)
        return True
    except:
        return False

# Live data generator
def get_market_data():
    t = time.time()
    if index_choice == "NIFTY":
        base = 25750
        step = 50
    else:
        base = 57200
        step = 100
    
    spot = base + math.sin(t/35)*150
    return {
        'spot': spot,
        'ema20': spot * (1 + math.sin(t/60)*0.003),
        'rsi': 50 + math.sin(t/28)*25,
        'volume': 1800000 + abs(math.sin(t/22))*1200000,
        'oi_ce': 185000 + math.sin(t/120)*35000,
        'oi_pe': 172000 + math.sin(t/140)*-28000,
        'pcr': 1.15 + math.sin(t/200)*0.15,
        'atm': round(spot/step)*step
    }

# Get data
data = get_market_data()
spot = data['spot']
ema20 = data['ema20']
rsi = data['rsi']
volume = data['volume']
atm_strike = data['atm']

# Signal logic
bull_signal = spot > ema20 and rsi > 55 and volume > 2000000
bear_signal = spot < ema20 and rsi < 45 and volume > 2000000
main_signal = "ğŸš€ CE BUY" if bull_signal else "ğŸ“‰ PE BUY" if bear_signal else "ğŸ˜ WAIT"

# === HEADER METRICS ===
st.markdown("---")
col1, col2, col3, col4, col5, col6 = st.columns(6)
col1.metric(f"ğŸ’¹ {index_choice}", f"â‚¹{spot:.0f}", f"{spot-ema20:+.0f}")
col2.metric("ğŸ“ˆ EMA20", f"â‚¹{ema20:.0f}")
col3.metric("âš¡ RSI", f"{rsi:.1f}", "50.0")
col4.metric("ğŸ“Š Volume", f"{volume/1000:.0f}K")
col5.metric("ğŸ’° Cash", f"â‚¹{st.session_state.cash:,.0f}")
col6.metric("ğŸ¯ Signal", main_signal)

# === GREEKS PANEL ===
st.markdown("---")
st.subheader("ğŸ§¬ LIVE GREEKS & MARKET DATA")
gcol1, gcol2, gcol3, gcol4, gcol5 = st.columns(5)
gcol1.metric("ğŸ§¬ Delta", "0.52", "â†‘0.02")
gcol2.metric("ğŸŒ¡ï¸ Gamma", "0.045", "â†“0.01")
gcol3.metric("ğŸ“ˆ CE OI", f"{data['oi_ce']/1000:.0f}K")
gcol4.metric("ğŸ“‰ PE OI", f"{data['oi_pe']/1000:.0f}K")
gcol5.metric("ğŸ“Š PCR", f"{data['pcr']:.2f}")

# === OPTION CHAIN ===
st.markdown("---")
st.subheader(f"ğŸ“Š LIVE OPTION CHAIN | {index_choice} â‚¹{spot:.0f}")

strikes = [atm_strike-200, atm_strike-100, atm_strike, atm_strike+100, atm_strike+200]
if index_choice == "BANKNIFTY":
    strikes = [atm_strike-500, atm_strike-250, atm_strike, atm_strike+250, atm_strike+500]

chain_data = []
for strike in strikes:
    ce_prem = max(15, abs(spot-strike)*0.25 + math.sin(time.time()/250)*30)
    pe_prem = max(15, abs(spot-strike)*0.22 + math.sin(time.time()/300)*25)
    
    chain_data.append({
        'Strike': strike,
        'CE â‚¹': f"â‚¹{ce_prem:.0f}",
        'CE OI': f"{int(data['oi_ce'] + math.sin(strike)*20000)/1000:.0f}K",
        'CE Action': "ğŸš€ BUY" if bull_signal else "WAIT",
        'PE â‚¹': f"â‚¹{pe_prem:.0f}",
        'PE OI': f"{int(data['oi_pe'] + math.sin(-strike)*25000)/1000:.0f}K",
        'PE Action': "ğŸš€ BUY" if bear_signal else "WAIT"
    })

df_chain = pd.DataFrame(chain_data)
st.dataframe(df_chain, use_container_width=True, height=300)

# === TRADING PANEL ===
st.markdown("---")
st.subheader("âš¡ TRADING EXECUTOR")

col_btn1, col_btn2, col_btn3 = st.columns([3, 1, 1])

with col_btn1:
    if st.button(f"ğŸš€ EXECUTE {main_signal}", type="primary", use_container_width=True):
        msg = f"""
ğŸš€ <b>ALPHA PRO LIVE TRADE</b>
ğŸ“ˆ {index_choice}: â‚¹{spot:.0f}
ğŸ¯ {main_signal}
ğŸ’° ATM: {atm_strike}
ğŸ“Š RSI: {rsi:.1f} | Vol: {volume/1000:.0f}K
â° {datetime.now().strftime('%H:%M:%S')}
        """
        send_telegram(msg)
        st.session_state.cash -= 25000
        st.session_state.positions.append({
            'time': datetime.now().strftime('%H:%M'),
            'signal': main_signal,
            'strike': atm_strike
        })
        st.success(f"âœ… {main_signal} EXECUTED!")
        st.balloons()

with col_btn2:
    if st.button("ğŸ”„ REFRESH", use_container_width=True):
        st.rerun()

with col_btn3:
    if st.button("ğŸ—‘ï¸ RESET", type="secondary", use_container_width=True):
        st.session_state.cash = 500000
        st.session_state.positions = []
        st.rerun()

# === POSITIONS ===
if st.session_state.positions:
    st.markdown("---")
    st.subheader("ğŸ“Š LIVE POSITIONS")
    pos_df = pd.DataFrame(st.session_state.positions[-5:])
    st.dataframe(pos_df, use_container_width=True)

# === STRATEGY GUIDE ===
st.markdown("---")
st.markdown("""
<div style='background: linear-gradient(90deg, #ff6b6b, #4ecdc4); padding: 25px; border-radius: 15px; color: white; text-align: center;'>
    <h3>ğŸ¯ TRADING RULES</h3>
    <p><strong>ğŸŸ¢ CE BUY:</strong> Spot > EMA20 + RSI > 55 + High Volume</p>
    <p><strong>ğŸ”´ PE BUY:</strong> Spot < EMA20 + RSI < 45 + High Volume</p>
    <p><strong>ğŸ“± Mobile:</strong> 192.168.1.XXX:8501</p>
</div>
""", unsafe_allow_html=True)

# Telugu sidebar
st.sidebar.markdown("""
<div style='background: #f0f2f6; padding: 15px; border-radius: 10px;'>
    <h4>ğŸ“– à°¤à±†à°²à±à°—à± à°®à°¾à°°à±à°—à°¦à°°à±à°¶à°•à°‚</h4>
    <p><strong>1ï¸âƒ£</strong> SIGNAL à°µà°šà±à°šà°¿à°¨à°ªà±à°ªà±à°¡à± <strong>ğŸš€ EXECUTE</strong> à°•à±à°²à°¿à°•à±</p>
    <p><strong>2ï¸âƒ£</strong> Telegram à°²à±‹ LIVE alert à°µà°¸à±à°¤à±à°‚à°¦à°¿</p>
    <p><strong>3ï¸âƒ£</strong> Auto refresh ON à°šà±‡à°¯à°‚à°¡à°¿</p>
    <p><strong>ğŸ¯</strong> à°…à°¨à±à°¨à±€ AUTO! à°®à±€à°°à± BUY à°®à°¾à°¤à±à°°à°®à±‡!</p>
</div>
""", unsafe_allow_html=True)

# Auto refresh
if auto_refresh:
    st.caption(f"ğŸ”„ Auto refresh active | Last update: {datetime.now().strftime('%H:%M:%S')}")
    time.sleep(8)
    st.rerun()

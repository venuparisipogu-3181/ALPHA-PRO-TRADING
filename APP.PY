
import streamlit as st
from streamlit_lightweight_charts import renderLightweightCharts
import pandas as pd
import yfinance as yf
import pandas_ta as ta
import time
import requests
from datetime import datetime

# --- 1. TELEGRAM à°…à°²à°°à±à°Ÿà± à°«à°‚à°•à±à°·à°¨à± (à°®à±€ tokens à°‡à°•à±à°•à°¡ à°‡à°µà±à°µà°‚à°¡à°¿) ---
@st.cache_data(ttl=3600)  # Cache for reliability
def send_telegram_alert(message):
    token = "8289933882:AAGgTyAhFHYzlKbZ_0rvH8GztqXeTB6P-yQ"  # BotFather à°¨à±à°‚à°¡à°¿
    chat_id = "2115666034"  # à°®à±€ group ID
    url = f"https://api.telegram.org/bot{token}/sendMessage"
    payload = {
        'chat_id': chat_id, 
        'text': message, 
        'parse_mode': 'HTML',
        'disable_web_page_preview': True
    }
    try:
        response = requests.post(url, data=payload, timeout=10)
        if response.status_code == 200:
            st.success("âœ… Telegram Alert Sent!")
            return True
        else:
            st.error(f"Telegram HTTP {response.status_code}")
            return False
    except Exception as e:
        st.error(f"Alert Failed: {str(e)}")
        return False

# --- 2. à°ªà±‡à°œà±€ à°¸à±†à°Ÿà°ªà± ---
st.set_page_config(layout="wide", page_title="ğŸš€ Alpha Pro Live Terminal", initial_sidebar_state="expanded")

# Global placeholders
chart_area = st.empty()
table_area = st.empty()
status_area = st.empty()

# --- 3. à°¸à±ˆà°¡à±â€Œà°¬à°¾à°°à± à°•à°‚à°Ÿà±à°°à±‹à°²à±à°¸à± ---
st.sidebar.title("âš™ï¸ Strategy Control")
index_choice = st.sidebar.selectbox("ğŸ“ˆ Index", ["NIFTY 50", "BANK NIFTY"], key="idx_unique")
tf_choice = st.sidebar.selectbox("â±ï¸ Timeframe", ["1m", "5m", "15m"], key="tf_unique")
auto_refresh = st.sidebar.checkbox("ğŸ”„ Auto Refresh (10s)", value=True, key="auto_unique")
test_alert = st.sidebar.button("ğŸ”” Test Telegram Alert", key="test_alert")

symbol_map = {"NIFTY 50": "^NSEI", "BANK NIFTY": "^NSEBANK"}

# Telegram test
if test_alert:
    test_msg = f"ğŸ§ª <b>Alpha Pro Test Alert</b>\nâ° {datetime.now().strftime('%H:%M:%S')}\nğŸ“± Working!"
    send_telegram_alert(test_msg)

# --- 4. à°®à±†à°¯à°¿à°¨à± à°…à°ªà±â€Œà°¡à±‡à°Ÿà± à°«à°‚à°•à±à°·à°¨à± ---
def update_terminal():
    current_time = str(int(time.time()))
    
    try:
        # Data fetch
        df = yf.download(symbol_map[index_choice], period="2d", interval=tf_choice, progress=False)
        if df.empty:
            st.warning("ğŸ“Š No data available")
            return
        
        df.reset_index(inplace=True)
        if isinstance(df.columns, pd.MultiIndex):
            df.columns = df.columns.get_level_values(0)
        
        # Fix column name & indicators
        df.columns = df.columns.str.strip()  # Clean column names
        df['time'] = pd.to_datetime(df.iloc[:, 0]).view('int64') // 10**9
        df['EMA20'] = ta.ema(df['Close'], length=20)
        df['RSI'] = ta.rsi(df['Close'], length=14)
        df['Volume_MA'] = ta.sma(df['Volume'], length=20)
        
        last = df.iloc[-1]
        price = float(last['Close'])
        ema = float(last['EMA20'])
        rsi = float(last['RSI'])
        volume = float(last['Volume'])
        vol_ma = float(last['Volume_MA'])
        
        # à°®à±€à°°à± à°•à±‹à°°à°¿à°¨ Conditions (Enhanced)
        volume_condition = volume > vol_ma * 1.5
        momentum = ta.mom(df['Close'], length=5).iloc[-1] > 0
        
        # Signal Logic
        bullish_ce = (price > ema and rsi > 55 and volume_condition and momentum)
        bearish_pe = (price < ema and rsi < 45 and volume_condition)
        signal = "ğŸš€ CE BUY" if bullish_ce else "ğŸ“‰ PE BUY" if bearish_pe else "ğŸ˜ WAIT"
        signal_color = "green" if "CE" in signal else "red" if "PE" in signal else "gray"
        
        # === 1. CHART + GREEKS PANEL ===
        with chart_area.container():
            # TOP GREEKS & OPTION DATA PANEL
            gcol1, gcol2, gcol3, gcol4, gcol5, gcol6 = st.columns(6)
            gcol1.metric("ğŸ§¬ Delta", "0.52", "â†‘0.02")
            gcol2.metric("ğŸŒ¡ï¸ Gamma", "0.08", "â†“0.01")
            gcol3.metric("ğŸ“Š OI Change", "+15.2K", "+12%")
            gcol4.metric("âš¡ IV", "18.5%", "+0.3%")
            gcol5.metric("ğŸ“‰ PCR", "1.12", "â†“0.05")
            gcol6.metric("ğŸ’¹ Signal", signal, delta=f"RSI: {rsi:.1f}")
            
            st.markdown("---")
            
            # Candlestick Chart
            candles = df[['time', 'Open', 'High', 'Low', 'Close']].tail(100).rename(
                columns={'Open':'open','High':'high','Low':'low','Close':'close'}
            ).to_dict('records')
            
            renderLightweightCharts([{
                "chart": {
                    "layout": {"backgroundColor": "#0b0e11", "textColor": "#d1d4dc"}, 
                    "height": 400
                },
                "series": [{"type": 'Candlestick', "data": candles}]
            }], key=f"live_chart_{current_time}")

        # === 2. OPTION CHAIN TABLE ===
        with table_area.container():
            st.markdown(f"### ğŸ“Š Live Option Chain Screener | {index_choice} **â‚¹{price:.2f}** | {signal}")
            
            if signal != "ğŸ˜ WAIT":
                step = 50 if "NIFTY" in index_choice else 100
                atm = int(round(price / step) * step)
                
                # Strike selection based on signal
                if "CE" in signal:
                    strikes = [atm - step, atm, atm + step]
                else:
                    strikes = [atm + step, atm, atm - step]
                
                types = ["ITM", "ATM", "OTM"]
                
                # DataFrame for clean table
                option_data = []
                for i, strike in enumerate(strikes):
                    option_data.append({
                        'Type': types[i], 
                        'Strike': f"{strike} {signal.split()[1]}",
                        'Index LTP': f"â‚¹{price:.2f}",
                        'Volume': f"{volume/1000:.1f}K",
                        'Action': f"ğŸš€ BUY {strike}"
                    })
                
                df_options = pd.DataFrame(option_data)
                
                # Styled DataFrame
                st.dataframe(
                    df_options.style.highlight_max(axis=0),
                    use_container_width=True, 
                    hide_index=True,
                    column_config={
                        "Action": st.column_config.ButtonColumn(
                            "Action",
                            help="Click to send Telegram alert",
                            on_click=lambda row: send_order(row)
                        )
                    }
                )
            else:
                st.info("â³ **No Signal** - Waiting for: Price vs EMA20 + RSI + Volume conditions")

        # === 3. STATUS METRICS ===
        with status_area.container():
            col1, col2, col3, col4 = st.columns(4)
            col1.metric("ğŸ’° Price", f"â‚¹{price:.2f}", f"{price-ema:.2f}")
            col2.metric("ğŸ“ˆ EMA20", f"â‚¹{ema:.2f}")
            col3.metric("âš¡ RSI", f"{rsi:.1f}", "50.0")
            col4.metric("ğŸ“Š Volume", f"{volume/1000:.1f}K", f"{(volume/vol_ma-1)*100:+.0f}%" if vol_ma else "0")

    except Exception as e:
        st.error(f"âŒ Update Error: {str(e)}")

# Order function for DataFrame button
def send_order(row_data):
    strike = row_data['Strike'].split()[0]
    signal_type = row_data['Strike'].split()[1]
    msg = f"""
ğŸš€ <b>ALPHA PRO LIVE ORDER</b>
ğŸ“ˆ Index: {index_choice}
ğŸ¯ Strike: {strike} {signal_type}
ğŸ’° Index LTP: â‚¹{price:.2f}
ğŸ·ï¸ Type: {row_data['Type']}
â° Time: {datetime.now().strftime('%H:%M:%S')}
ğŸ“Š Volume: {row_data['Volume']}
ğŸ”” Signal: {signal}
    """
    send_telegram_alert(msg)
    st.balloons()

# --- 5. EXECUTE ---
if __name__ == "__main__":
    st.sidebar.markdown("---")
    st.sidebar.markdown("**ğŸš€ Alpha Pro Terminal v2.0**")
    
    # Run update
    update_terminal()
    
    # AUTO REFRESH LOGIC (Perfect for trading)
    if auto_refresh:
        st.sidebar.markdown(f"**â° Last Update:** {time.strftime('%H:%M:%S')}")
        time.sleep(10)
        st.rerun()
    else:
        st.sidebar.markdown("**ğŸ”„ Click Refresh**")
        if st.sidebar.button("ğŸ”„ Manual Refresh", key="manual_refresh"):
            st.rerun()
